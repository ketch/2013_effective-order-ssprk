\section{Optimal effective order SSP Runge-Kutta schemes}\label{sec:optimal_ESSPRK}
In this section we use the effective order conditions to construct an SSP main method $M$ and 
its corresponding starting and finishing methods $S, S^{-1}$. 
Methods $S$ and $S^{-1}$ are not generally SSP, but as we see later the resulting scheme can 
be reinterpreted so that they are.

We rely on the SSP theory and the Butcher's theory of effective order, previously reviewed in 
Sections \ref{sec:SSP} and \ref{sec:Algebraic_RK}, to find optimal explicit SSP Runge-Kutta 
schemes with prescribed effective and classical order. 
Due to Corollary~\ref{cor:no-ssp-5}, we need only consider methods with effective order up 
to four.

Recall from Section~\ref{sec:Algebraic_RK} that the methods of effective order involve a main 
method $M$ as well as starting and finishing methods $S$ and $S^{-1}$.
Note from Table~\ref{tab:effective_OCs} that the conditions for the main method $M$ up to 
order four do not depend on the coefficients $\beta$ of the methods $S, S^{-1}$. 
Therefore, the search for optimal methods of effective order can be carried out in two steps, 
first searching for optimal methods $M$ and then for methods $S, S^{-1}$.

We denote by ESSPRK($s,q,p$) an $s$--stage Explicit SSP Runge--Kutta method of effective 
$q$--order and classical $p$--order. 
Also we write SSPRK($s,q$) for a ``classical" $s$-stage Explicit SSP Runge--Kutta method of 
$q$--order.

\subsection{The main method}\label{subsec:main_method}
We begin by formulating an optimization problem for the main method $M$. 
Then we discuss the optimal SSP cofficients with respect to the those of linear problems and 
SSPRK($s,q$) methods. Some families for third and fourth effective order methods are also 
presented.

\subsubsection{The optimization problem}\label{subsubsec:opt_problem}
Our aim is to find the optimal main method that has the largest possible SSP coefficient for 
nonlinear problems, for a given number of stages, effective order, and classical order. 
Assume that the ESSPRK($s,q,p$) method $M$ has Butcher tableau
$(A, \bm{b}, \bm{c})$ and 
reconsider the optimization problem~\eqref{eq:SSP_opt} with $\Phi_{q,p}(K)$ representing 
now the conditions for effective order $q$ and classical order $p$.

The methods are found through numerical search, using \textsc{MATLAB}'s optimization 
toolbox on the above constrained optimization problem. 
Specifically, we use \texttt{fmincon} with a sequential quadratic programming approach.
This process does not guarantee a global minimizer, so many searches from random initial 
guesses are performed to try to ensure the method with the largest possible SSP coefficient is 
found.

\subsubsection{Optimal SSP coefficients}\label{subsubsec:optimal_SSP_coeff}
The effective SSP coefficients for up to eleven stages are shown in 
Table~\ref{tab:eff_SSP_coeff}. 
Similarly with SSPRK($s$, $q$) methods, all effective SSP coefficients of ESSPRK($s,q,p$) methods 
have $\sspcoef < 1$. 
Since the $q$--effective order SSP methods (accompanied with relevant starting and finishing 
methods) are used in a scheme that attains classical order equal to $q$, it is reasonable to 
compare their accuracy with the ESSPRK($s,q$) methods.
We then have the following results:
\begin{result}
	ESSPRK($s,q,p$) methods have SSP coefficients $\sspcoef$ greater than or equal to that of 
	SSPRK($s$, $q$) methods.
\end{result}
\begin{result}
	Many of the ESSPRK($s,q,p$) methods (and all of those with $s \ge 7$ stages) we have 
	found by numerical search, have SSP coefficients $\sspcoef$ which achieve the linear 
	bound. 
	\colintodo{a list that do not
    achieve the linear bound: ESSPRK(4,4,2) and ESSPRK(5,4,2), 543,
    443, 643}
	This shows they are optimal.  
\end{result}

\begin{table}
    \centering
    \begin{tabular}{|c|c|ccccccccccc|}
        \hline
        \multicolumn{2}{|c|}{\backslashbox{\hspace{2pt}\vspace{1pt}$q\,,\,p$}{\vspace{-5.5pt}$s$}} & $1$ & $2$ & $3$ & $4$ & $5$ & $6$ & $7$ & $8$ & $9$ & $10$ & $11$ \\
        \hline
        $q = 3$ & $p = 2$ & $-$ & $-$ & $\bf 0.33$ & $\bf 0.50$ & $\bf 0.53$ & $\bf 0.59$ & $\bf 0.61$ & $\bf 0.64$ & $\bf 0.67$ & $\bf 0.68$ & $\bf 0.69$\\
        \hline
        $q = 4$ & $p = 2$ & $-$ & $-$ & $-$ & $0.22$ & $0.39$ & $\bf 0.44$ & $\bf 0.50$ & $\bf 0.54$ & $\bf 0.57$ & $\bf 0.60$ & $\bf 0.62$ \\
        \hline
        $q = 4$ & $p = 3$ & $-$ & $-$ & $-$ & $0.19$ & $0.37$ & $0.43$ & $\bf 0.50$ & $\bf 0.54$ & $\bf 0.57$ & $\bf 0.60$ & $\bf 0.62$ \\
        \hline
    \end{tabular}
    \caption{Effective SSP coefficients $ \ceff = \sspcoef/s$ of best known explicit effective 
    		order ESSPRK($s,q,p$) methods. 
    		Entries in bold achieve the linear bound on the SSP coefficient and are therefore optimal. 
    		If no positive $\sspcoef$ can be found, we use ``$-$'' to indicate non-existence. 
    		The optimal fourth-order linear bounds for $s=4$ and $s=5$ are $0.25$ and $0.40$ 
    		respectively.}
    \label{tab:eff_SSP_coeff}
\end{table}

\subsubsection{Effective order three methods}\label{subsubsec:3rd_ESSPRK}
Table~\ref{tab:eff_SSP_coeff} shows that ESSPRK($s$, $3$, $2$) are optimal because they match the linear bounds. 
Note however that these bounds are also attained by classical third-order SSPRK methods up to 11 stages. 
In the cases of three and four stages, we were able to determine closed-form families of solutions.
\begin{theorem}\label{thm:ESSPRK(3,3,2)}
	An optimal family of three-stage, third effective order SSP Runge--Kutta methods of 
	classical order two, with SSP coefficient $\sspcoef=1$ is given by
    \begin{displaymath}
    		\begin{split}
    			\bm{Y}_1 &= \bm{u}^n \\
    			\bm{Y}_2 &= \bm{u}^n + \Dt\bm{F}(\bm{Y}_1) \\
    			\bm{Y}_3 &= \bm{u}^n + \gamma\Dt\bm{F}(\bm{Y}_1) + \gamma\Dt\bm{F}(\bm{Y}_2) \\
    			\bm{u}^{n+1} &= \bm{u}^n + \frac{5\gamma-1}{6\gamma}\Dt\bm{F}(\bm{Y}_1) + \frac{1}{6}\Dt\bm{F}(\bm{Y}_2) + \frac{1}{6\gamma}\Dt\bm{F}(\bm{Y}_3),
        \end{split}
    \end{displaymath}
    where $1/4 \leq \gamma \leq 1$ is a free parameter. We denote the above family as 
    ESSPRK($3,3,2$).
\end{theorem}
\begin{theorem}\label{thm:ESSPRK(4,3,2)}
	An optimal family of four-stage, third effective order SSP Runge--Kutta methods of 
	classical order two, with SSP coefficient $\sspcoef=2$ is given by
    \begin{displaymath}
    		\begin{split}
    			\bm{Y}_1 &= \bm{u}^n \\
    			\bm{Y}_2 &= \bm{u}^n + \frac{1}{2}\Dt\bm{F}(\bm{Y}_1) \\
    			\bm{Y}_3 &= \bm{u}^n + \frac{1}{2}\Dt\bm{F}(\bm{Y}_1) + \frac{1}{2}\Dt\bm{F}(\bm{Y}_2) \\
    			\bm{Y}_4 &= \bm{u}^n + \gamma\Dt\bm{F}(\bm{Y}_1) + \gamma\Dt\bm{F}(\bm{Y}_2) + + \gamma\Dt\bm{F}(\bm{Y}_3) \\
    			\bm{u}^{n+1} &= \bm{u}^n + \frac{8\gamma-1}{12\gamma}\Dt\bm{F}(\bm{Y}_1) + \frac{1}{6}\Dt\bm{F}(\bm{Y}_2) + \frac{1}{6}\Dt\bm{F}(\bm{Y}_3) + \frac{1}{12\gamma}\Dt\bm{F}(\bm{Y}_4),
        \end{split}
    \end{displaymath}
    where $ 1/6 \leq \gamma \leq 1/2 $ is a free parameter. We denote the above family as 
    ESSPRK($4,3,2$).
\end{theorem}
\begin{proof}
	In either theorem, feasibility can be verified by direct calculation of the conditions in 
	problem~\eqref{eq:SSP_opt}. Optimality follows because the families achieve the 
	appropriate linear bound.
\end{proof}

Theorem~\ref{thm:ESSPRK(3,3,2)} gives a \emph{family} of three-stage methods. 
The particular value of $\gamma = 1/4$ corresponds to the classical Shu--Osher 
SSPRK($3,3$) method \cite{Gottlieb1998}.
Similarly, in Theorem~\ref{thm:ESSPRK(4,3,2)} the particular value of $\gamma = 1/6$ 
corresponds to the usual SSPRK($4,3$) method.
It seems possible that for each number of stages $s$, the ESSPRK($s, 3, 2$) methods may 
form a family in which an optimal SSPRK($s$, $3$) method is a particular member. 
In general ESSPRK($s,q,p$) methods can be thought us a generalization of the SSPRK($s$, $q$) 
class. 

\subsubsection{Effective order four methods}\label{subsubsec:4th_ESSPRK}
For effective order four, most methods found are optimal because they match the linear 
bounds and they are at least as good as the SSPRK($s$, $4$) (they are all better except in the 
case where $s =10$, in which are equal). 
Unlike effective order three, here ESSPRK($s,4,p$) methods, for $p = 2,3$ have generally 
larger SSP coefficients $\sspcoef$ compared to SSPRK($s$, $4$). 
Also, for stages $s > 7$ the SSP coefficient of ESSPRK($s,4,2$) and ESSPRK($s,4,3$) are the 
same. 
In particular for four-stage methods we have the following result:
\begin{result}
	In contrast with the non-existence of SSPRK($4$, $4$) method \cite{Gottlieb1998,Ruuth2002}, 
	we were are able to find ESSPRK($4,4,2$) and ESSPRK($4,4,3$) methods.
\end{result}

\subsection{Starting and finishing methods}\label{subsec:starting_finishing}
Having constructed an ESSPRK($s,q,p$) scheme that can be used as the main method $M$, we 
need to find the perturbation methods $S$ and $S^{-1}$ such that the Runge-Kutta scheme 
$S^{-1}MS$ attains classical order $q$, equal to the effective order of method $M$. 

We are interested in applying the $S^{-1}MS$ scheme $n$ times and recall from section 
\ref{sec:Effective_order} that this results in an $S^{-1}M^nS$ scheme. 
But, if method $S$ advances the solution in time, then $S^{-1}$ must evolve the solution 
backward in time, which is undesirable in some cases. 
For this reason, starting and finishing methods $S, S^{-1}$ are usually designed to perturb
the solution but not advance in time. 
A drawback of this approach is that the resulting $S^{-1}M^nS$ Runge-Kutta scheme is not 
SSP. 
The conditions $SS^{-1} = I$ and $\beta_1 = 0$ lead to $\beta_1 = \beta^{-1}_1 = 0$ and 
hence the methods $S$ and $S^{-1}$ must satisfy $\sum b_i = 0$. 
Thus they cannot be SSP.

In order to overcome this problem and achieve ``bona fide'' effective order SSPRK methods we 
need to choose different starting and finishing methods. 
In the construction of $S^{-1}M^nS$ Runge-Kutta schemes, we consider equivalent methods 
$R$ and $T$ as starting and finishing methods, such that their order conditions are those of 
$MS$ and $S^{-1}M$, respectively. 
In practice, the new starting and finishing methods must be equivalent to $MS$ and 
$S^{-1}M$ up to order $q$. 
In other words if $\rho$ and $\tau$ are the corresponding functions in group $G$ of methods $R$ and $T$, then
\begin{equation} \label{eq:R_T_OCs}
    \rho(t) = (\beta\alpha)(t) \text{ and } \tau(t) = (\alpha\beta^{-1})(t), \quad \text{for all 
    trees $t$ with $r(t) \leq q$,}
\end{equation}
and therefore,
\begin{equation} \label{eq:RMT_OCs}
    \rho\alpha\tau(t) = E^3(t), \quad \text{for all trees $t$ with $r(t) \leq q$.}
\end{equation}
Now the $S^{-1}M^nS$ is equivalent to the $TM^{n-2}R$ scheme and attains classical order $q$.

\subsection{Optimizing the staring and finishing methods}\label{subsubsec:opt_methods}
The order conditions from \eqref{eq:R_T_OCs} do not contradict the SSP requirements.  
We can thus use the optimization procedure described in Section~\ref{subsec:Optimal_SSPRK} 
with these order conditions instead of the $\Phi_{p,q}$ in \eqref{eq:SSP_opt}. 
Rewriting the second condition in \eqref{eq:R_T_OCs} as $(\tau\beta)(t) = \alpha(t)$ 
the 
order conditions for the starting and finishing methods are given in 
Table~\ref{tab:rho_tau_OCs}. 
\yiannistodo{Replace $\beta_2$ since it is known in both 3rd and 4th order}
Note that for either case of order $q=3$ or $q=4$, the algebraic expressions on 
$\beta$ up to order $q-1$ are already found by the optimization procedure of 
the main method (see Table~\ref{tab:effective_OCs}). 
However, the values of the $q$--order elementary weights on $\beta$ are not known; these 
are $\beta_3$ and $\beta_4$ for third effective order and $\beta_5$ to $\beta_8$ for fourth 
effective order. 

One can obtain these values by finding the relevant methods $S$ and $S^{-1}$. 
It is sufficient to satisfy $S^{-1}S = I$ up to order $q$ and we can construct an optimization 
problem that minimizes the magnitude of the coefficients appearing in these two methods.
Care must be taken so that the conditions on $\beta$ given in Table~\ref{tab:effective_OCs} for the third and fourth effective order also hold. 
\yiannistodo{No discussion about the minimum stages of S, right?}

\begin{table}
	\centering
	\begin{tabular}{lcl}
		\hline
    		\multicolumn{1}{c}{$\rho(t) = (\beta\alpha)(t)$} & & \multicolumn{1}{c}{$(\tau\beta)(t) = \alpha(t)$} \\
    		\hline
    		 $\rho_1 = \alpha_1$ & & $\tau_1 = \alpha_1$ \\
    		$\rho_2 = \alpha_2 + \beta_2$ & & $\tau_2 = \alpha_2 - \beta_2$ \\
    		$\rho_3 = \alpha_3 + \beta_3$ & & $\tau_3 = \alpha_3 - 2\alpha_1\beta_2 - \beta_3$ \\
    		$\rho_4 = \alpha_4 + \alpha_1\beta_2 + \beta_4$ & & $\tau_4 = \alpha_4 - \alpha_1\beta_2 - \beta_4$ \\\\
		$\rho_5 = \alpha_5 + \beta_5$ & & $\tau_5 = \alpha_5 - 3\alpha_1\beta_2^2 - 3\alpha_1\beta_3 - \beta_5$ \\
		$\rho_6 = \alpha_6 + \alpha_2\beta_2 + \beta_6$ & & $\tau_6 = \alpha_6 - (\alpha_1^2 + \alpha_2 -\beta_2)\beta_2 -\alpha_1\beta_3 - \alpha_1\beta_4 - \beta_6$ \\
		$\rho_7 = \alpha_7 + \alpha_1\beta_3 + \beta_7$ & & $\tau_7 = \alpha_7 - 2\alpha_1\beta_4 - \alpha_1^2\beta_2 - \beta_7$ \\
		$\rho_8 = \alpha_8 + \alpha_1\beta_4 + \alpha_2\beta_2 + \beta_8$ & & $\tau_8 = \alpha_8 - \alpha_1\beta_4 - \alpha_2\beta_2 + \beta_2^2 -  \beta_8$
  	\end{tabular}
  	\caption{Order conditions on $\rho$ and $\tau$ up to fourth effective order for starting 
  	and finishing methods $R$ and $T$, respectively (the upper block represents the third 
  	effective order conditions).}
  	\label{tab:rho_tau_OCs}
\end{table}

\subsection{Resulting schemes}\label{subsec:resulting_schemes}
We were able to construct starting and finishing schemes for each main method, with an SSP 
coefficient at least as large as that of the main method. 
This constraint does not allow these methods to have the same number of stages as the main method. 
Specifically if the main method is ESSPRK($s,3,2$) the starting and finishing methods have 
$s+1$ and $s$ stages, respectively. 
The results in the case of fourth effective order are summarized in Table~\ref{tab:RT_stages}. 
The starting and finishing processors found are first order accurate, except when the main 
method is ESSPRK($s,4,3$). 
In such case they achieve second order accuracy. 

\begin{table}
    \centering
    \begin{tabular}{|c|c|cccccccc|}
        \hline
        \multicolumn{2}{|c|}{\backslashbox{\hspace{1pt}\vspace{1pt}$p$}{\vspace{-5pt}$s$}} & $4$ & $5$ & $6$ & $7$ & $8$ & $9$ & $10$ & $11$ \\
        \hline
        \multirow{2}{*}{$2$} & $R$ & $5$ & $7$ & $7$ & $8$ & $8$ & $10$ & $11$ & $12$ \\
        & $T$ & $5$ & $5$ & $6$ & $7$ & $8$ & $9$ & $10$ & $11$ \\
        \hline
        \multirow{2}{*}{$3$}& $R$ & $5$ & $6$ & $7$ & $8$ & $9$ & $10$ & $11$ & $12$ \\
        & $T$ & $5$ & $5$ & $7$ & $8$ & $8$ & $10$ & $11$ & $12$ \\
        \hline
    \end{tabular}
    \caption{Number of stages for the starting ($R$) and finishing ($T$) methods related to a fourth effective order ESSPRK($s,4,p$) main method.}
    \label{tab:RT_stages}
\end{table}

In general, the starting and finishing methods have minimal computational and storage cost 
especially if we consider that they replace the action of two methods. 
This is in contrast with their large importance in raising the order of the $TM^{n-2}R$ scheme 
from low classical order to higher effective order of method $M$.
If accurate values are needed at any time other than the final time, the computation must invoke 
the stopping method, and then the starting method to start up again. 
\todo{This should be explained earlier too, with just special notice here because its $RT$ not $SS^{-1}$}

Tables \ref{tab:ESSPRK(4,4,2)_scheme} and \ref{tab:ESSPRK(4,4,3)_scheme} show the coefficients 
\yiannistodo{Is it better to  write them in terms of fractions?}
of the effective SSP schemes in the case the main method is ESSPRK($4,4,2$) and 
ESSPRK($4,4,3$), respectively. 

\begin{sidewaystable}
    \centering
    \small
    \subfloat[ESSPRK($4,4,2$) \label{ESSPRK(4,4,2)_scheme_a}]{
        \begin{tabular}{c | c c c c}
             $0$ & & & & \\
             $0.730429885784024$ & $0.730429885784024$ & & & \\
             $0.644963741710099$ & $0.251830567791499$ & $0.393133173918601$ & & \\
             $1.000000000000000$ & $0.141062646387053$ & $0.220213163087548$ & $0.638724190525399$ & \\
             \hline
             & $0.384422058644697$ & $0.261153837271738$ & $0.127250866803383$ & $0.227173237280182$
        \end{tabular}
    }\\
    \subfloat[Starting method $R$ \label{ESSPRK(4,4,2)_scheme_b}]{
        \begin{tabular}{c | c c c c c}
			$0$ & $0$ & & & \\
			$0.373522916411400$ & $0.373522916411400$ & & & & \\
			$0.427950722860423$ & $0.131590527793077$ & $0.296360195067346$ & & & \\
			$0.638639971034253$ & $0.066215361487869$ & $0.149126215815910$ & $0.423298393730474$ & & \\
			$1.000000000000000$ & $0.059378615605483$ & $0.099226317694128$ & $0.281656318212781$ & $0.559738748487608$ & \\		
             \hline
             & $0.167820631351745$ & $0.266506504585377$ & $0.094688801056065$ & $0.188176112416812$ & $0.282807950590000$ 
        \end{tabular}
    }\qquad
    \subfloat[Finishing method $T$ \label{ESSPRK(4,4,2)_scheme_c}]{
        \begin{tabular}{c | c c c c c}
			$0$ & & & & & \\
			$0.502859501089623$ & $0.502859501089623$ & & & & \\
			$0.932299154557159$ & $0.466149577278579$ & $0.466149577278579$ & & & \\
			$0.592066180887698$ & $0.291363412015344$ & $0.144655475088422$ & $0.156047293783932$ & & \\
			$0.820219483624087$ & $0.389493128711985$ & $0.077538391027073$ & $0.083644646541993$ & $0.269543317343036$ & \\
             \hline            
             & $0.357516861171415$ & $0.120524890425247$ & $0.051000692115440$ & $0.164348781516878$ & $0.306608774771021$ 
        \end{tabular}
    }
    \caption{Fourth order effective SSP scheme where the main method $M$ is ESSPRK(4,4,2).}  
    \label{tab:ESSPRK(4,4,2)_scheme}
\end{sidewaystable}

\begin{sidewaystable}
    \centering
    \small
    \subfloat[ESSPRK($4,4,2$) \label{ESSPRK(4,4,3)_scheme_a}]{
        \begin{tabular}{c | c c c c}
             $0$ & & & & \\
             $0.601245068769723$ & $0.601245068769723$ & & & \\
             $0.436888719184949$ & $0.139346828936332$ & $0.297541890248617$ & & \\
             $0.747760163759696$ & $0.060555450003183$ & $0.129301708523521$ & $0.557903005232992$ & \\
             \hline
             & $0.220532078494543$ & $0.180572397262273$ & $0.181420582935982$ & $0.417474941307203$
        \end{tabular}
    }\\
    \subfloat[Starting method $R$ \label{ESSPRK(4,4,3)_scheme_b}]{
        \begin{tabular}{c | c c c c c}
			$0$ & $0$ & & & & \\
			$0.233583075787679$ & $0.233583075787679$ & & & & \\
			$0.515691493839167$ & $0.113222521489861$ & $0.402468972349307$ & & & \\
			$0.531082309996490$ &$0.044673367659019$ & $0.158799187092104$ & $0.327609755245368$ & & \\
			$0.781350492733201$ & $0.125069004030275$ & $0.133636207609711$ & $0.147871644558862$ & $0.374773636534354$ & \\			
             \hline
             & $0.154940460576884$ & $0.122447291145256$ & $0.196845001120610$ & $0.163510218326813$ & $0.362257028830438$
        \end{tabular}
    }\qquad
    \subfloat[Finishing method $T$ \label{ESSPRK(4,4,3)_scheme_c}]{
        \begin{tabular}{c | c c c c c c c}
			$0$ & & & & & \\
			$0.439651096124100$ & $0.439651096124100$ & & & & \\
			$0.703468818352023$ & $0.297025122670221$ & $0.406443695681802$ & & & \\
			$0.428982979460892$ & $0.097632937435411$ & $0.133599109579618$ & $0.197750932445863$ & & \\
			$0.874787742275635$ & $0.082872736093259$ & $0.113401522491430$ & $0.167854837386445$ & $0.510658646304502$ & \\			
             \hline
             & $0.182401342203530$ & $0.219128338221130$ & $0.078473760154594$ & $0.238737856798909$ & $0.281258702621837$
        \end{tabular}
    }
    \caption{Fourth order effective SSP scheme where the main method $M$ is ESSPRK(4,4,3).}
    \label{tab:ESSPRK(4,4,3)_scheme}
\end{sidewaystable}

