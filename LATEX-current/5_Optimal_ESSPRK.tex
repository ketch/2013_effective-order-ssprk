\section{Optimal effective order SSP Runge-Kutta schemes}\label{sec:Optimal_ESSPRK}
In this section we use the effective order conditions to
construct an SSP main method $M$ and its corresponding starting and finishing
methods $S,S^{-1}$.  Methods $S$ and $S^{-1}$ are not generally SSP, but as we see later a the resulting scheme can be reinterpreted so that they are.

We rely on the SSP theory and the Butcher's theory of effective order,
previously reviewed in Sections \ref{sec:SSP} and \ref{sec:Algebraic_RK}, to
find optimal explicit SSP Runge-Kutta schemes with prescribed effective and classical order.  Due to Corollary~\ref{cor:no-ssp-5}, we need only consider methods with effective order 
up to four.

Recall from Section~\ref{sec:Algebraic_RK} that the methods of effective order involve
a main method $M$ as well as starting and finishing methods $S$ and $S^{-1}$.
Note from Table~\ref{tab:Effective_oc} that the conditions for the main method $M$
up to order four do not depend on the coefficients $\beta$ of the methods $S,S^{-1}$. 
Therefore, the search for optimal methods of effective order can be carried out in
two steps, first searching for optimal methods $M$ and then for methods $S,S^{-1}$.


We denote by ESSPRK($s,q,p$) an $s$-stage Explicit SSP Runge-Kutta method of
effective order $q$ and classical order $p$. If $q=p$ then we simply write ESSPRK($s,p$). 

\subsection{The main method}\label{subsection3.1}

We begin by formulating an optimisation problem for the main method $M$. Then we discuss 
the optimal SSP cofficients with respect to the those for linear problems and we present classes of method for particular choices of stage and effective order.

\subsubsection{The optimisation problem\label{subsection3.1.1}}

Our aim is to find the optimal main method that has the largest possible
SSP coefficient for nonlinear problems, for a given number of stages, effective order,
and classical order. 
Assume that the ESSPRK(\( s \),\( q \),\( p \)) method \( M \) has Butcher tableau  \( (A, \bm{b}) \)
and reconsider the optimization problem~\eqref{eqSSPopt}
with \( \Phi_{q,p}(K) \) representing  the conditions for effective order $q$ and classical order $p$.
% \begin{equation}
%     \max_{A, \bm{b}^{\texttt{T}}, r} r, \qquad \text{subject to } \quad \left\{
%                                                  \begin{array}{ll}
%                                                    N \geq 0 \\
%                                                    \textbf{e}_{s+1} - rN\textbf{e}_{s} \geq 0 \\
%                                                    \Phi_{p,q}(K) = 0,
%                                                  \end{array}
%                                                \right.
% \end{equation}

The methods are found through numerical search, using
\textsc{MATLAB}'s optimization toolbox on the above constrained
optimization problem.  Specifically, we use \verb"fmincon" with a
sequential quadratic programming approach.
This process does not guarantee a global minimizer, so several
searches are performed to try to ensure the method with the largest possible SSP coefficient is found.

\subsubsection{An upper bound: the optimal threshold factor}
Useful upper bounds for the foregoing optimization problem can be obtained
by consider an important relaxation.  In the relaxed problem, the method is
required to be accurate and strong stability preserving only for linear,
constant-coefficient initial value problems.  This leads to a reduced set of
order conditions and a reduced set of absolute monotonicity conditions.  We
denote the resulting optimal value by $\clin$; clearly for any method
$$\sspcoef\le\clin.$$
Exact optimal values of $\clin$ are known for many classes of methods; for example see
\cite{Kraaijevanger1986,ketcheson2009a}.



\subsubsection{Optimal SSP coefficients\label{subsection3.1.2}}

The effective SSP coefficients for up to eleven stages are shown in Table~\ref{tab:5.1}. For the computation of ESSPRK(\( s \),\( 4 \),\( 3 \)) methods we use the effective order conditions with \( \beta_{3} \neq 0 \). This allows more freedom in the choice of coefficients since less equations must be satisfied. Similarly with SSPRK methods, all effective SSP coefficients of ESSPRK methods have \( c_{ef\!f} < 1 \). We have the following results:

\begin{result}
  ESSPRK have $\sspcoef$ greater than or equal to that of SSPRK.
\end{result}

\begin{result}
  Many of the ESSPRK (including all of those with many stages) we have
  found by numerical search have $\sspcoef$ which achieve the linear
  bound.  This shows they are optimal.  \todo{a list that do not
    achieve the linear bound: ESSPRK(4,4,2) and ESSPRK(5,4,2), 543,
    443, 643}
\end{result}

\begin{table}[t!]
    \centering
    \begin{tabular}{|c|c|ccccccccccc|}
        \hline
        \multicolumn{2}{|c|}{\backslashbox{\hspace{2pt}\vspace{1pt}$q\,,\,p$}{\vspace{-5.5pt}\( s \)}} & \( 1 \) & \( 2 \) & \( 3 \) & \( 4 \) & \( 5 \) & \( 6 \) & \( 7 \) & \( 8 \) & \( 9 \) & \( 10 \) & \( 11 \) \\
        \hline
        \( q = 3 \) & \( p = 2 \) & \( - \) &  \( - \) & \( \bf 0.33 \) & \( \bf 0.50 \) & \( \bf 0.53 \) & \( \bf 0.59 \) & \( \bf 0.61 \) & \( \bf 0.64 \) & \( \bf 0.67 \) & \( \bf 0.68 \) & \( \bf 0.69 \) \\
        \hline
        \( q = 4 \) & \( p = 2 \) & \( - \) & \( - \)  & \( - \)    & \( 0.22 \) & \( 0.39 \) & \( \bf 0.44 \) & \( \bf 0.50 \) & \( \bf 0.54 \) & \( \bf 0.57 \) & \( \bf 0.60 \) & \( \bf 0.62 \) \\
        \hline
        \( q = 4  \) & \( p = 3 \) & \( - \) & \( - \)  & \( - \)    & \( 0.19 \) & \( 0.37 \) & \( 0.43 \) & \( \bf 0.50 \) & \( \bf 0.54 \) & \( \bf 0.57 \) & \( \bf 0.60 \) & \( \bf 0.62 \) \\
        \hline
    \end{tabular}
    \caption{Effective SSP coefficients $ c_{ef\!f} $ of best known explicit effective order SSPRK($s$,$q$,$p$) methods. Entries in bold achieve the linear bound on the SSP coefficient and are therefore optimal. The optimal linear bounds for $s=4$ and $s=5$ are $0.25$ and $0.40$ respectively.}
    \label{tab:5.1}
\end{table}


\subsubsection{Effective order three methods}\label{subsubsection3.4.1}


% Even though a second order SSPRK method of effective order three is used for the main part of the computation, the \( PM^{n-2}T \) scheme has the same efficiency with a scheme that uses a three-order SSPRK method \( n \) times. Table \ref{table5.2} gives the SSPRK(\( 3 \),\( 3 \),\( 2 \)) scheme and its relevant permutation methods.

Table~\ref{tab:5.1} shows that ESSPRK($s$,$3$,$2$) are optimal because they match the linear bounds. Also, these bounds are attained by classical 3rd order SSPRK methods up to 11 stages. We were able to find optimal families for three and four stages.

\begin{theorem}\label{thm:ESSPRK(3,3,2)}
  %If we require positive coefficients, an optimal three-stage, third effective order SSP Runge Kutta method of classical order two, is given by
  An optimal family of three-stage, third effective order
  SSP Runge--Kutta methods of classical order two, with SSP
  coefficient $\sspcoef=1$ is given by
    \begin{displaymath}
        \begin{split}
            \bm{Y}_{1} &= \bm{u}^{n} \\
            \bm{Y}_{2} &= \bm{u}^{n} + \Dt\bm{F}(\bm{Y}_{1}) \\
            \bm{Y}_{3} &= \bm{u}^{n} + \gamma\Dt\bm{F}(\bm{Y}_{1}) + \gamma\Dt\bm{F}(\bm{Y}_{2}) \\
            \bm{u}^{n+1} &= \bm{u}^{n} + \frac{5\gamma-1}{6\gamma}\Dt\bm{F}(\bm{Y}_{1}) + \frac{1}{6}\Dt\bm{F}(\bm{Y}_{2}) + \frac{1}{6\gamma}\Dt\bm{F}(\bm{Y}_{3}),
        \end{split}
    \end{displaymath}
    where \( 1/4 \leq \gamma \leq 1 \) is a free parameter. We denote the above family as ESSPRK($3$,$3$,$2$).
\end{theorem}

\begin{proof}
One can check that this method has $\sspcoef = 1$ by verifying the SSP and order conditions of the optimization problem~\eqref{eqSSPopt}. Since this is the linear bound which has been achieved therefore it is optimal.
\end{proof}

Theorem~\ref{thm:ESSPRK(3,3,2)} gives an \emph{family} of three-stage methods.
The particular value of $\gamma = \frac{1}{4}$ corresponds to the
classical Shu-Osher SSPRK(3,3) method \yiannistodo{cite}.  
%We note in Table~\ref{tab:5.1} that SSPRK(\( s \),\( 3 \),\( 2 \)) methods have the same SSP coefficients as SSPRK(\( s \),\( 3 \)). 
In general, it seems possible that for each $s$, the ESSPRK($s$, $3$,$2$) may form a family of which the optimal SSPRK($s$,$3$) is a particular member. 
\todo{but is the optimal SSPRK($s,3$) unique?}

\begin{theorem}\label{thm:ESSPRK(4,3,2)}
  %If we require positive coefficients, an optimal three-stage, third effective order SSP Runge Kutta method of classical order two, is given by
  An optimal family of four-stage, third effective order
  SSP Runge--Kutta methods of classical order two, with SSP
  coefficient $\sspcoef=2$ is given by
    \begin{displaymath}
        \begin{split}
            \bm{Y}_{1} &= \bm{u}^{n} \\
            \bm{Y}_{2} &= \bm{u}^{n} + \frac{1}{2}\Dt\bm{F}(\bm{Y}_{1}) \\
            \bm{Y}_{3} &= \bm{u}^{n} + \frac{1}{2}\Dt\bm{F}(\bm{Y}_{1}) + \frac{1}{2}\Dt\bm{F}(\bm{Y}_{2}) \\
            \bm{Y}_{4} &= \bm{u}^{n} + \gamma\Dt\bm{F}(\bm{Y}_{1}) + \gamma\Dt\bm{F}(\bm{Y}_{2}) + + \gamma\Dt\bm{F}(\bm{Y}_{3}) \\
            \bm{u}^{n+1} &= \bm{u}^{n} + \frac{8\gamma-1}{12\gamma}\Dt\bm{F}(\bm{Y}_{1}) + \frac{1}{6}\Dt\bm{F}(\bm{Y}_{2}) + \frac{1}{6}\Dt\bm{F}(\bm{Y}_{3}) + \frac{1}{12\gamma}\Dt\bm{F}(\bm{Y}_{4}),
        \end{split}
    \end{displaymath}
    where $ 1/6 \leq \gamma \leq 1/2 $ is a free parameter. We denote the above family as ESSPRK($4$,$3$,$2$).
\end{theorem}
\begin{proof}
	Similar with Theorem~\ref{thm:ESSPRK(3,3,2)}
\end{proof}

As before Theorem~\ref{thm:ESSPRK(3,3,2)} gives an \emph{family} of four-stage methods.
The particular value of $\gamma = \frac{1}{6}$ corresponds to the usual SSPRK($4$,$3$) method.

% \qquad As described in the previous section, using \( n \) times an SSPRK(\( s \),\( q \),\( p \)) method as the main method \( M \) accompanied by the relevant starting and finishing methods \( P \) and \( T \) respectively, the resulting Runge-Kutta scheme \( PM^{n-2}T \) attains order \( q \).

\subsubsection{Effective order four methods}\label{subsubsection3.4.2}

  Second row: most of these are optimal b/c they match the linear bounds and they are at least as good as the SSPRK (they are all better except (10,4) which is equal).  Third row: still better than SSPRK.

For effective order four most methods found are optimal because they match the linear bounds and they are at least as good as the SSPRK (they are all better except (10,4) which is equal). Unlike effective order three, here ESSPRK methods have generally larger SSP coefficients $\sspcoef$ compared to SSPRK. Also, for stages \( s > 7 \) the SSP coefficient of SSPRK(\( s \),\( 4 \),\( 2 \)) and SSPRK(\( s \),\( 4 \),\( 3 \)) are the same. In particular for four-stage methods we have the following result.

\begin{result}
  In contrast with the non-existence of SSP(\( 4 \),\( 4 \)) method
  \cite{Gottlieb1998,Ruuth2002}, we were are able to
  find SSPRK(\( 4 \),\( 4 \),\( 2 \)) and SSPRK(\( 4 \),\( 4 \),\( 3
  \)) methods.
\end{result}



%The big advantage comes when we use SSPRK(\( s \),\( 4 \),\( p \)) for method \( M \).

%Then, the corresponding \( PM^{n-2}T \) SSPRK scheme has order four and greater or at least equal SSP coefficients than the SSPRK(\( s \),\( 4 \)) methods.

%Their corresponding \( RM^{n-2}T \) schemes are presented in Tables \ref{table5.3} and \ref{table5.4}.

\todo{possible result on ($n^2+1$, 4,2) methods: should not hold up paper waiting for this result.}


\subsubsection{Non-existence of fifth-order schemes}\label{sec:noESSP5}

There is no explicit effective order 5 SSP methods.  This is a corollary of Theorem~\ref{thm:positiveb} and the following lemma.

\begin{lemma}\label{lem:ssp_pos_coef}\cite{Ruuth2002}
  \todo{is this also in Kraaijevanger \cite{Kraaijevanger1991}?}
  An SSPRK method
  %with \( \alpha_{ij}, \beta_{ij} \geq 0 \)
  %in the Shu-Osher form
  has Butcher Tableau \( (A,\textbf{b}^{\texttt{T}},\textbf{c}) \) with positive weight coefficients \( \textbf{b} > 0 \).
\end{lemma}

\todo{[In this paper, we should remove mentions of $\alpha$ and $\beta$ that refer something other than Butcher's tree stuff]}

The effective order SSPRK methods found are optimal among all SSPRK methods, since their SSP coefficients either match the threshold factors for linear problems \yianniscomment{see SSPRK(s,3,2)} or are at least equal with the already known SSPRK methods. \yianniscomment{see SSPRK(s,4,2) \& SSPRK(s,4,3)}

\colincomment{I don't think the previous is quite right}

%Further more, this combination allows the construction of a
%four-stage, effective order four SSPRK scheme and thus in some sense overcomes the
%non-existence of an SSPRK(\( 4 \),\( 4 \)) method.  This scheme uses a
%four-stage, four-effective SSPRK method of classical order either two
%or three, accompanied by specific starting and finishing methods.

\comment{With the exception of the four-effective SSP methods of four and five stages, the effective SSP methods for nonlinear problems have SSP coefficients equal to those for linear problems, hence the upper bound is obtained \cite{Kraaijevanger1986}.}


\subsection{Starting and finishing methods}\label{subsection3.2}
Having constructed an SSPRK(\( s \),\( q \),\( p \)) scheme that can
be used as the main method \( M \), we need to find the perturbation
methods \( S \) and \( S^{-1} \) such that the Runge-Kutta scheme \(
SM^{n}S^{-1} \) attains classical order $q$ (the effective order of
method \( M \)).

If method $S$ advances the solution in time,
then $S^{-1}$ must evolve the solution backward in time, which is undesirable in
some cases.  For this reason,
starting and finishing methods $S,S^{-1}$ are usually designed to perturb
the solution but not advance in time.  
A drawback of this approach is that the resulting \(
SM^{n}S^{-1} \) Runge-Kutta scheme is not SSP. The conditions \( S^{-1}S = I \)
and \( \beta_{1} = 0 \) as lead to \( \beta_{1} = \beta^{-1}_{1} = 0 \) and
hence the methods \( S \) and \( S^{-1} \) must satisfy $\sum b_i = 0$.  Thus
they cannot be SSP.  

\todo{$SM$ or $MS$ order: this section isn't updated.}

In order to overcome this problem and achieve ``bona fide'' effective order SSPRK methods we need to choose different starting and finishing methods. In the construction of \( SM^{n}S^{-1} \) Runge-Kutta schemes, we consider \( P = SM \) and \( T = MS^{-1} \) as starting and finishing methods, respectively. Then the scheme becomes \( PM^{n-2}T \), where the order conditions of methods \( P \) and \( T \) are those of \( SM \) and \( MS^{-1} \), respectively.
%Hence, the new starting and finishing methods belong in the equivalent class of methods \( SM \) and \( MS^{-1} \), respectively.
In practice, the new starting and finishing methods must be equivalent to \( SM \) and \( MS^{-1} \), respectively, up to order $q$.
 In other words if \( \rho \) and \( \tau \) are the corresponding functions in group $G_1$ of methods \( P \) and \( T \), then
\begin{subequations} \label{eq:PT_OCs}
\begin{align}
    \rho(t) &= \alpha\beta(t), \quad \text{for all trees $t$ with $r(t) \leq q$,} \\
    \tau(t) &= \beta^{-1}\alpha(t), \quad \text{for all trees $t$ with $r(t) \leq q$,}
\end{align}
\end{subequations}
$$
    \rho\alpha^{n-2}\tau(t) = E(t), \quad \text{for all trees $t$ with $r(t) \leq q$,}
$$
and the scheme \( PM^{n-2}T \) is a method of classical order \( q \).

The order conditions from \eqref{eq:PT_OCs} do not contradict the SSP
requirements.  We can thus use the optimization procedure described in
Section~\ref{subsection3.1.1} with these order conditions instead of
the $\Phi_{p,q}$ in \eqref{eqSSPopt}. 

\subsubsection{Resulting schemes}
We have constructed starting and finishing schemes for each main scheme,
with SSP coefficient at least as large as that of the main scheme.
Table x shows the number of stages required to obtain this in each case.
Table \ref{tab:essprk442-S} shows the coefficients of the starting and finishing methods for 
ESSPRK(4,4,2).

The perturbation methods have minimal computational and storage cost, in
contrast with their large importance in raising the order of the \(
SM^{n}S^{-1} \) scheme from low classical order to higher effective order of
method \( M \).

If accurate values are needed at any time other than the final time, the
computation must invoke the stopping method, and then the starting method to start up again. \todo{This should be explained earlier too, with just special notice here because its $RT$ not $SS^{-1}$}

Table~\ref{tab:essprk442} shows the ESSPRK(4,4,2) scheme.

\begin{table}
  \caption{ESSPRK(4,4,2) and its starting/stopping methods}
  \label{tab:essprk442}
  \centering
  \begin{tabular}{|c|c|c|}
    \hline
    TODO & TODO & TODO \\
    \hline
  \end{tabular}
\end{table}
